<!-- templates/view_patient.html -->

{% extends "base.html" %}
{% block content %}
<div class="mt-5 w-100">
    <h2>Patient Details</h2>
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ patient.firstname }} {{ patient.lastname }}</h5>
            <a href="#" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editPatientModal">Edit Patient Info</a>
        </div>        
        <div class="card-body">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="patientTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="patient-info-tab" data-bs-toggle="tab" href="#patient-info" role="tab" aria-controls="patient-info" aria-selected="true">Patient Info</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="immunization-tab" data-bs-toggle="tab" href="#immunization" role="tab" aria-controls="immunization" aria-selected="false">Immunization</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="allergy-tab" data-bs-toggle="tab" href="#allergy" role="tab" aria-controls="allergy" aria-selected="false">Allergy</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="medication-tab" data-bs-toggle="tab" href="#medication" role="tab" aria-controls="medication" aria-selected="false">Medication</a>
                </li>      
            </ul>
    
            <!-- Tab Content -->
            <div class="tab-content mt-3" id="patientTabsContent">
                <!-- Patient Info Tab -->
                <div class="tab-pane fade show active" id="patient-info" role="tabpanel" aria-labelledby="patient-info-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
                            <p><strong>Age:</strong> {{ patient.age }}</p>
                            <p><strong>Gender:</strong> {{ patient.gender }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Contact Number:</strong> {{ patient.contact_number }}</p>
                            <p><strong>Home Address:</strong> {{ patient.home_address }}</p>
                            <p><strong>Emergency Contact:</strong> {{ patient.ecd_name }} ({{ patient.ecd_contact_number }})</p>
                        </div>
                    </div>
                </div>

                <!-- Edit Patient Info Modal -->
                <div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_patient', patient_id=patient.id) }}">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editPatientModalLabel">Edit Patient Information</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Edit fields for patient info -->
                                     <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="patient_id">Patient ID</label>
                                                <input type="text" class="form-control" id="patient_id" name="patient_id" value="{{ patient.patient_id }}" readonly>
                                            </div>
                                            <div class="form-group">
                                                <label for="firstname">First Name</label>
                                                <input type="text" class="form-control" id="firstname" name="firstname" value="{{ patient.firstname }}" readonly>
                                            </div>
                                            <div class="form-group">
                                                <label for="lastname">Last Name</label>
                                                <input type="text" class="form-control" id="lastname" name="lastname" value="{{ patient.lastname }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="age">Age</label>
                                                <input type="number" class="form-control" id="age" name="age" value="{{ patient.age }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="gender">Gender</label>
                                                <select class="form-control" id="gender" name="gender" required>
                                                    <option value="Male" {% if patient.gender == "Male" %}selected{% endif %}>Male</option>
                                                    <option value="Female" {% if patient.gender == "Female" %}selected{% endif %}>Female</option>
                                                    <option value="Other" {% if patient.gender == "Other" %}selected{% endif %}>Other</option>
                                                </select>
                                            </div>
                                            
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="ecd_name">Emergency Contact Name</label>
                                                <input type="text" class="form-control" id="ecd_name" name="ecd_name" value="{{ patient.ecd_name }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="ecd_contact_number">Emergency Contact Number</label>
                                                <input type="text" class="form-control" id="ecd_contact_number" name="ecd_contact_number" value="{{ patient.ecd_contact_number }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="contact_number">Contact Number</label>
                                                <input type="text" class="form-control" id="contact_number" name="contact_number" value="{{ patient.contact_number }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="home_address">Home Address</label>
                                                <textarea class="form-control" id="home_address" name="home_address" required>{{ patient.home_address }}</textarea>
                                            </div>
                                        </div>
                                     </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>


    
                <!-- Immunization Tab -->
                <div class="tab-pane fade" id="immunization" role="tabpanel" aria-labelledby="immunization-tab">
                    <h5>Immunization Information</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Vaccine Code</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Lot Number</th>
                                    <th>Site</th>
                                    <th>Route</th>
                                    <th>Dose Quantity</th>
                                    <th>Manufacturer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for immunization in immunizations %}
                                <tr>
                                    <td>{{ immunization.vaccine_code }}</td>
                                    <td>{{ immunization.status }}</td>
                                    <td>{{ immunization.date }}</td>
                                    <td>{{ immunization.lot_number }}</td>
                                    <td>{{ immunization.site }}</td>
                                    <td>{{ immunization.route }}</td>
                                    <td>{{ immunization.dose_quantity }}</td>
                                    <td>{{ immunization.manufacturer }}</td>
                                    <td>
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#editImmunizationModal{{ immunization.id }}" class="btn btn-warning btn-sm">Edit</a>
                                        <form action="{{ url_for('main.delete_immunization', immunization_id=immunization.id) }}" method="POST" style="display:inline;">
                                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                        </form>                                        
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Edit Immunization Modals -->
                {% for immunization in immunizations %}
                <div class="modal fade" id="editImmunizationModal{{ immunization.id }}" tabindex="-1" aria-labelledby="editImmunizationModalLabel{{ immunization.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_immunization', patient_id=patient.id, immunization_id=immunization.id) }}">
                                {{ immunizationform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editImmunizationModalLabel{{ immunization.id }}">Edit Immunization</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <!-- Vaccine Code -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="vaccine_code_{{ immunization.id }}" class="form-label">Vaccine Code</label>
                                                <select class="form-control" id="vaccine_code_{{ immunization.id }}" name="vaccine_code" required>
                                                    {% for code, display in immunizationform.vaccine_code.choices %}
                                                    <option value="{{ code }}" {% if immunization.vaccine_code == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Status -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="status_{{ immunization.id }}" class="form-label">Status</label>
                                                <select class="form-control" id="status_{{ immunization.id }}" name="status" required>
                                                    {% for code, display in immunizationform.status.choices %}
                                                    <option value="{{ code }}" {% if immunization.status == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Date -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="date_{{ immunization.id }}" class="form-label">Date Administered</label>
                                                <input type="date" class="form-control" id="date_{{ immunization.id }}" name="date" value="{{ immunization.date }}" required>
                                            </div>
                                        </div>

                                        <!-- Lot Number -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="lot_number_{{ immunization.id }}" class="form-label">Lot Number</label>
                                                <input type="text" class="form-control" id="lot_number_{{ immunization.id }}" name="lot_number" value="{{ immunization.lot_number }}">
                                            </div>
                                        </div>

                                        <!-- Site -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="site_{{ immunization.id }}" class="form-label">Site</label>
                                                <select class="form-control" id="site_{{ immunization.id }}" name="site">
                                                    {% for code, display in immunizationform.site.choices %}
                                                    <option value="{{ code }}" {% if immunization.site == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Route -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="route_{{ immunization.id }}" class="form-label">Route</label>
                                                <select class="form-control" id="route_{{ immunization.id }}" name="route">
                                                    {% for code, display in immunizationform.route.choices %}
                                                    <option value="{{ code }}" {% if immunization.route == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Dose Quantity -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="dose_quantity_{{ immunization.id }}" class="form-label">Dose Quantity</label>
                                                <input type="text" class="form-control" id="dose_quantity_{{ immunization.id }}" name="dose_quantity" value="{{ immunization.dose_quantity }}">
                                            </div>
                                        </div>

                                        <!-- Manufacturer -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="manufacturer_{{ immunization.id }}" class="form-label">Manufacturer</label>
                                                <input type="text" class="form-control" id="manufacturer_{{ immunization.id }}" name="manufacturer" value="{{ immunization.manufacturer }}">
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="notes_{{ immunization.id }}" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes_{{ immunization.id }}" name="notes">{{ immunization.notes }}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}



                

                <!-- Allergy Tab -->
                <div class="tab-pane fade" id="allergy" role="tabpanel" aria-labelledby="allergy-tab">
                    <h5>Allergy Information</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Substance</th>
                                        <th>Clinical Status</th>
                                        <th>Verification Status</th>
                                        <th>Severity</th>
                                        <th>Type</th>
                                        <th>Category</th>
                                        <th>Reaction</th>
                                        <th>Onset</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for allergy in allergies %}
                                    <tr>
                                        <td>{{ allergy.substance }}</td>
                                        <td>{{ allergy.clinical_status }}</td>
                                        <td>{{ allergy.verification_status }}</td>
                                        <td>{{ allergy.severity }}</td>
                                        <td>{{ allergy.type }}</td>
                                        <td>{{ allergy.category }}</td>
                                        <td>{{ allergy.reaction }}</td>
                                        <td>{{ allergy.onset }}</td>
                                        <td>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#editAllergyModal{{ allergy.id }}" class="btn btn-warning btn-sm">Edit</a>
                                            <a href="{{ url_for('main.delete_allergy', allergy_id=allergy.id) }}" class="btn btn-danger btn-sm">Delete</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                </div>


                 <!-- Medication Tab -->
                 <div class="tab-pane fade" id="medication" role="tabpanel" aria-labelledby="medication-tab">
                    <h5>Medication Information</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Medication Code</th>
                                <th>Medication Name</th>
                                <th>Status</th>
                                <th>Effective Period Start</th>
                                <th>Effective Period End</th>
                                <th>Dosage Instruction</th>
                                <th>Timing</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for medication in medications %}
                            <tr>
                                <td>{{ medication.medication_code }}</td>
                                <td>{{ medication.medication_name }}</td>
                                <td>{{ medication.status }}</td>
                                <td>{{ medication.effectivePeriod_start }}</td>
                                <td>{{ medication.effectivePeriod_end }}</td>
                                <td>{{ medication.dosage_instruction }}</td>
                                <td>{{ medication.timing }}</td>
                                <td>{{ medication.reason_code }}</td>
                                <td>
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#editMedicationModal{{ medication.id }}" class="btn btn-warning btn-sm">Edit</a>
                                    <form action="{{ url_for('main.delete_medication', medication_id=medication.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form> 
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <h3>Appointment</h3>

    {% if latest_appointment %}
    <div class="card mb-3">
        <div class="card-header">
            Next appointment {{ latest_appointment.start.strftime('%Y-%m-%d') }}
            <a href="{{ url_for('main.view_visit', visit_id=latest_appointment.visit_id) }}" class="btn btn-info btn-sm float-right">View Details</a>
        </div>
        <div class="card-body">
            <p><strong>Visit Type:</strong> {{ latest_appointment.visit_type }}</p>
            <p><strong>Notes:</strong> {{ latest_appointment.notes }}</p>
        </div>
    </div>
    {% else %}
    <p>No upcoming appointments available.</p>
    {% endif %}

    <h3>Visits</h3>
    <table class="table table-bordered table-hover table-striped outline-table">
        <thead>
            <tr class="table-dark-row">
                <th>ID</th>
                <th>Visit Date</th>
                <th>Reason Code</th>
                <th>Class</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for visit in sorted_visits %}
            <tr>
                <td>{{ visit.id }}</td>
                <td>{{ visit.visit_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ visit.reason_code }} - {{ visit.reason_code_description }}</td>
                <td>{{ visit.class_code }}</td>  <!-- Assuming 'class_code' is an attribute of Visit -->
                <td>{{ visit.priority }}</td>  <!-- Assuming 'priority' is an attribute of Visit -->
                <td>{{ visit.status }}</td>
                <td>
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{{ url_for('main.view_visit', visit_id=visit.id) }}" class="btn btn-info btn-sm w-100">View Details</a>
                        </div>
                        <div class="col-md-6">
                            <button class=" btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#deleteVisitModal{{ visit.id }}">
                                Delete
                            </button>
                            <!-- Confirmation Modal -->
                            <div class="modal fade" id="deleteVisitModal{{ visit.id }}" tabindex="-1" aria-labelledby="deleteVisitModalLabel{{ visit.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form method="POST" action="{{ url_for('main.delete_visit', visit_id=visit.id) }}">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteVisitModalLabel{{ visit.id }}">Confirm Visit Deletion</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>To confirm deletion, please enter the full name of the patient:</p>
                                                <input type="text" name="patient_name" class="form-control" placeholder="Patient Name" required>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-danger">Delete Visit</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8">No visits recorded.</td>
            </tr>
            {% endfor %}

            
        </tbody>        
    </table>

    <!-- Add Visit Button -->
    <a href="{{ url_for('main.add_visit', patient_id=patient.id) }}" class="btn btn-success mt-3">Add New Visit</a>
</div>
{% endblock %}
