<!-- templates/view_patient.html -->

{% extends "base.html" %}
{% block content %}
<div class="mt-5 w-100">
    <h2>Patient Details</h2>
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ patient.firstname }} {{ patient.lastname }}</h5>       
        </div>        
        <div class="card-body">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="patientTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="patient-info-tab" data-bs-toggle="tab" href="#patient-info" role="tab" aria-controls="patient-info" aria-selected="true">Patient Info</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="medical_history-tab" data-bs-toggle="tab" href="#medical_history" role="tab" aria-controls="medical_history" aria-selected="false">Medical History</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="immunization-tab" data-bs-toggle="tab" href="#immunization" role="tab" aria-controls="immunization" aria-selected="false">Immunization</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="allergy-tab" data-bs-toggle="tab" href="#allergy" role="tab" aria-controls="allergy" aria-selected="false">Allergy</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="medication-tab" data-bs-toggle="tab" href="#medication" role="tab" aria-controls="medication" aria-selected="false">Medication</a>
                </li> 
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="appointment-tab" data-bs-toggle="tab" href="#appointment" role="tab" aria-controls="appointment" aria-selected="false">Appointment</a>
                </li>   
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="lab-scans-tab" data-bs-toggle="tab" href="#lab-scans" role="tab" aria-controls="lab-scans" aria-selected="false">Lab Scans</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="documents-tab" data-bs-toggle="tab" href="#documents" role="tab" aria-controls="documents" aria-selected="false">Documents</a>
                </li>
                   
            </ul>
    
            <!-- Tab Content -->
            <div class="tab-content mt-3" id="patientTabsContent">
                <!-- Patient Info Tab -->
                <div class="tab-pane fade show active" id="patient-info" role="tabpanel" aria-labelledby="patient-info-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
                            <p><strong>Age:</strong> {{ patient.age }}</p>
                            <p><strong>Gender:</strong> {{ patient.gender }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Contact Number:</strong> {{ patient.contact_number }}</p>
                            <p><strong>Home Address:</strong> {{ patient.home_address }}</p>
                            <p><strong>Emergency Contact:</strong> {{ patient.ecd_name }} ({{ patient.ecd_contact_number }})</p>
                        </div>
                    </div>
                    <div class="col-12 d-flex justify-content-end align-items-center">
                        <div class="d-flex">
                            <a href="#" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editPatientModal">Edit Patient Info</a>
                        </div>
                    </div>
                </div>

                <!-- Medical History Tab -->
                <div class="tab-pane fade" id="medical_history" role="tabpanel" aria-labelledby="medical_history-tab">
                    <h5 class="d-flex justify-content-between align-items-center mb-3">
                        Medical History
                        <a href="#" data-bs-toggle="modal" data-bs-target="#addMedicalHistoryModal" class="btn btn-warning btn-sm">Add</a>
                    </h5>
                    <hr class="mb-3"> <!-- Horizontal line as a divider -->
                    {% for medicalhistory in medicalhistory  %}
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Category:</strong> {{ medicalhistory.category }}</p>
                            <p><strong>Code:</strong> {{ medicalhistory.code }}</p>
                            <p><strong>Clinical Status:</strong> {{ medicalhistory.clinical_status }}</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Verification Status:</strong> {{ medicalhistory.verification_status }}</p>
                            <p><strong>Onset Date:</strong> {{ medicalhistory.onset_date }}</p>
                            <p><strong>Abatement Date:</strong> {{ medicalhistory.abatement_date }}</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Notes:</strong> {{ medicalhistory.notes }}</p>
                        </div>
                    </div>
                    <!-- Buttons in the same row as medical history -->
                    <!-- Buttons in the same row as medical history -->
                    <div class="col-12 d-flex justify-content-end align-items-center">
                        <div class="d-flex">
                            <!-- Edit Button -->
                            <a href="#" data-bs-toggle="modal" data-bs-target="#editMedicalHistoryModal{{ medicalhistory.id }}" class="btn btn-warning btn-sm me-2">Edit</a>

                            <!-- Delete Button -->
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteMedicalHistoryModal{{ medicalhistory.id }}">
                                Delete
                            </button>
                        </div>
                        <!-- Confirmation Modal -->
                        <div class="modal fade" id="deleteMedicalHistoryModal{{ medicalhistory.id }}" tabindex="-1" aria-labelledby="deleteMedicalHistoryModalLabel{{ medicalhistory.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form method="POST" action="{{ url_for('main.delete_medical_history', patient_id=patient.id, medicalhistory_id=medicalhistory.id) }}">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteMedicalHistoryModalLabel{{ medicalhistory.id }}">Confirm Visit Deletion</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>To confirm deletion, please enter the full name of the patient:</p>
                                            <input type="text" name="patient_name" class="form-control" placeholder="Patient Name" required>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-danger">Delete Visit</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Immunization Tab -->
                <div class="tab-pane fade" id="immunization" role="tabpanel" aria-labelledby="immunization-tab">
                    <h5>Immunization Information</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Vaccine Code</th>
                                    <th>Vaccine Description</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Lot Number</th>
                                    <th>Site</th>
                                    <th>Route</th>
                                    <th>Dose Quantity</th>
                                    <th>Manufacturer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for immunization in immunizations %}
                                <tr class="{% if immunization.status == 'completed' %}table-success{% endif %}">
                                    <td>{{ immunization.vaccine_code }}</td>
                                    <td>{{ immunization.vaccine_code_description }} </td>
                                    <td>{{ immunization.status }}</td>
                                    <td>{{ immunization.date }}</td>
                                    <td>{{ immunization.lot_number }}</td>
                                    <td>{{ immunization.site }}</td>
                                    <td>{{ immunization.route }}</td>
                                    <td>{{ immunization.dose_quantity }}</td>
                                    <td>{{ immunization.manufacturer }}</td>
                                    <td>
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#editImmunizationModal{{ immunization.id }}" class="btn btn-warning btn-sm">Edit</a>
                                        <form action="{{ url_for('main.delete_immunization', immunization_id=immunization.id) }}" method="POST" style="display:inline;">
                                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                        </form>                                        
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Allergy Tab -->
                <div class="tab-pane fade" id="allergy" role="tabpanel" aria-labelledby="allergy-tab">
                    <h5>Allergy Information</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Substance</th>
                                        <th>Clinical Status</th>
                                        <th>Verification Status</th>
                                        <th>Severity</th>
                                        <th>Type</th>
                                        <th>Category</th>
                                        <th>Reaction</th>
                                        <th>Onset</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for allergy in allergies %}
                                    <tr>
                                        <td>{{ allergy.substance }}</td>
                                        <td>{{ allergy.clinical_status }}</td>
                                        <td>{{ allergy.verification_status }}</td>
                                        <td>{{ allergy.severity }}</td>
                                        <td>{{ allergy.type }}</td>
                                        <td>{{ allergy.category }}</td>
                                        <td>{{ allergy.reaction }}</td>
                                        <td>{{ allergy.onset }}</td>
                                        <td>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#editAllergyModal{{ allergy.id }}" class="btn btn-warning btn-sm">Edit</a>
                                            <a href="{{ url_for('main.delete_allergy', allergy_id=allergy.id) }}" class="btn btn-danger btn-sm">Delete</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                </div>

                 <!-- Medication Tab -->
                <div class="tab-pane fade" id="medication" role="tabpanel" aria-labelledby="medication-tab">
                    <h5>Medication Information</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Medication Code</th>
                                <th>Medication Name</th>
                                <th>Status</th>
                                <th>Effective Period Start</th>
                                <th>Effective Period End</th>
                                <th>Dosage Instruction</th>
                                <th>Timing</th>
                                <th>Reason</th>
                                <th>Visit ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for medication in medications %}
                            <tr class="{% if medication.status == 'completed' %}table-success{% endif %}">
                                <td>{{ medication.medication_code }}</td>
                                <td>{{ medication.medication_name }}</td>
                                <td>{{ medication.status }}</td>
                                <td>{{ medication.effectivePeriod_start }}</td>
                                <td>{{ medication.effectivePeriod_end }}</td>
                                <td>{{ medication.dosage_instruction }}</td>
                                <td>{{ medication.timing }}</td>
                                <td>{{ medication.reason_code }}</td>
                                <td>{{ medication.visit_id}}</td>
                                <td>
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#editMedicationModal{{ medication.id }}" class="btn btn-warning btn-sm">Edit</a>
                                    <form action="{{ url_for('main.delete_medication', medication_id=medication.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form> 
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Appointment Tab -->
                <!-- Appointments -->
                <div class="tab-pane fade" id="appointment" role="tabpanel" aria-labelledby="appointment-tab">
                    <h3>All Appointments</h3> 
                    <small>Including upcoming and finished appointments.</small>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Service Category</th>
                                <th>Service Type</th>
                                <th>Specialty</th>
                                <th>Appointment Type</th>
                                <th>Priority</th>
                                <th>Reason</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for appointment in patient.appointments %}
                            <tr class="{% if appointment.status == 'fulfilled' %}table-success{% endif %}">
                                <td>{{ appointment.service_category }}</td>
                                <td>{{ appointment.service_type }}</td>
                                <td>{{ appointment.specialty }}</td>
                                <td>{{ appointment.appointment_type }}</td>
                                <td>{{ appointment.priority }}</td>
                                <td>{{ appointment.reason_code }}</td>
                                <td>{{ appointment.start }}</td>
                                <td>{{ appointment.end }}</td>
                                <td>{{ appointment.status }}</td>
                                <td>
                                    <!-- Edit Button -->
                                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editAppointmentModal{{ appointment.id }}">Edit</button>
                                    <!-- Delete Button -->
                                    <form method="POST" action="{{ url_for('main.delete_appointment', appointment_id=appointment.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this appointment?');">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Lab Scans Tab -->
                <div class="tab-pane fade" id="lab-scans" role="tabpanel" aria-labelledby="lab-scans-tab">
                    <h5 class="mb-3 d-flex justify-content-between align-items-center">
                        Lab Scans
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#addFolderModal">Add Folder</button>
                    </h5>
                    <hr class="mb-3">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered w-100"> <!-- Ensuring full width of the table -->
                            <thead>
                                <tr>
                                    <th>Folder Name</th>
                                    <th>Created On</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in lab_scan_groups %}
                                <tr>
                                    <td>{{ group.group_name }}</td>
                                    <td>{{ group.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('main.view_lab_scans', patient_id=patient.id, group_id=group.id) }}" class="btn btn-info btn-sm">View Scans</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                    <h5 class="mb-3 d-flex justify-content-between align-items-center">
                        Additional Documents
                        <a href="{{ url_for('main.upload_document_page', patient_id=patient.id) }}" class="btn btn-warning btn-sm">Upload</a>
                    </h5>
                    <hr class="mb-3">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered w-100"> <!-- w-100 ensures full width -->
                            <thead>
                                <tr>
                                    <th>Document Name</th>
                                    <th>Uploaded On</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in additional_documents %}
                                <tr>
                                    <td>{{ document.document_name }}</td>
                                    <td>{{ document.upload_date }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('main.download_document', document_id=document.id) }}" class="btn btn-primary btn-sm">Download</a>
                                        <form method="POST" action="{{ url_for('main.delete_document', patient_id=patient.id, document_id=document.id) }}" class="d-inline-block ml-2">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this document?')">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Add Folder Modal -->
                <div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="addFolderModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.create_lab_scan_group', patient_id=patient.id) }}">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addFolderModalLabel">Add New Folder</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="groupName" class="form-label">Folder Name</label>
                                        <input type="text" class="form-control" id="groupName" name="group_name" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Create Folder</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Edit Patient Info Modal -->
                <div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_patient', patient_id=patient.id) }}">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editPatientModalLabel">Edit Patient Information</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Edit fields for patient info -->
                                     <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="patient_id">Patient ID</label>
                                                <input type="text" class="form-control" id="patient_id" name="patient_id" value="{{ patient.patient_id }}" readonly>
                                            </div>
                                            <div class="form-group">
                                                <label for="firstname">First Name</label>
                                                <input type="text" class="form-control" id="firstname" name="firstname" value="{{ patient.firstname }}">
                                            </div>
                                            <div class="form-group">
                                                <label for="lastname">Last Name</label>
                                                <input type="text" class="form-control" id="lastname" name="lastname" value="{{ patient.lastname }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="age">Age</label>
                                                <input type="number" class="form-control" id="age" name="age" value="{{ patient.age }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="gender">Gender</label>
                                                <select class="form-control" id="gender" name="gender" required>
                                                    <option value="Male" {% if patient.gender == "Male" %}selected{% endif %}>Male</option>
                                                    <option value="Female" {% if patient.gender == "Female" %}selected{% endif %}>Female</option>
                                                    <option value="Other" {% if patient.gender == "Other" %}selected{% endif %}>Other</option>
                                                </select>
                                            </div>
                                            
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="ecd_name">Emergency Contact Name</label>
                                                <input type="text" class="form-control" id="ecd_name" name="ecd_name" value="{{ patient.ecd_name }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="ecd_contact_number">Emergency Contact Number</label>
                                                <input type="text" class="form-control" id="ecd_contact_number" name="ecd_contact_number" value="{{ patient.ecd_contact_number }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="contact_number">Contact Number</label>
                                                <input type="text" class="form-control" id="contact_number" name="contact_number" value="{{ patient.contact_number }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="home_address">Home Address</label>
                                                <textarea class="form-control" id="home_address" name="home_address" required>{{ patient.home_address }}</textarea>
                                            </div>
                                        </div>
                                     </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Edit Immunization Modals -->
                {% for immunization in immunizations %}
                <div class="modal fade" id="editImmunizationModal{{ immunization.id }}" tabindex="-1" aria-labelledby="editImmunizationModalLabel{{ immunization.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_immunization', patient_id=patient.id, immunization_id=immunization.id) }}">
                                {{ immunizationform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editImmunizationModalLabel{{ immunization.id }}">Edit Immunization</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <!-- Vaccine Code -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="vaccine_code_{{ immunization.id }}" class="form-label">Vaccine Code</label>
                                                <select class="form-control" id="vaccine_code_{{ immunization.id }}" name="vaccine_code" required>
                                                    {% for code, display in immunizationform.vaccine_code.choices %}
                                                    <option value="{{ code }}" {% if immunization.vaccine_code == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Status -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="status_{{ immunization.id }}" class="form-label">Status</label>
                                                <select class="form-control" id="status_{{ immunization.id }}" name="status" required>
                                                    {% for code, display in immunizationform.status.choices %}
                                                    <option value="{{ code }}" {% if immunization.status == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Date -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="date_{{ immunization.id }}" class="form-label">Date Administered</label>
                                                <input type="date" class="form-control" id="date_{{ immunization.id }}" name="date" value="{{ immunization.date }}" required>
                                            </div>
                                        </div>

                                        <!-- Lot Number -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="lot_number_{{ immunization.id }}" class="form-label">Lot Number</label>
                                                <input type="text" class="form-control" id="lot_number_{{ immunization.id }}" name="lot_number" value="{{ immunization.lot_number }}">
                                            </div>
                                        </div>

                                        <!-- Site -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="site_{{ immunization.id }}" class="form-label">Site</label>
                                                <select class="form-control" id="site_{{ immunization.id }}" name="site">
                                                    {% for code, display in immunizationform.site.choices %}
                                                    <option value="{{ code }}" {% if immunization.site == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Route -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="route_{{ immunization.id }}" class="form-label">Route</label>
                                                <select class="form-control" id="route_{{ immunization.id }}" name="route">
                                                    {% for code, display in immunizationform.route.choices %}
                                                    <option value="{{ code }}" {% if immunization.route == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Dose Quantity -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="dose_quantity_{{ immunization.id }}" class="form-label">Dose Quantity</label>
                                                <input type="text" class="form-control" id="dose_quantity_{{ immunization.id }}" name="dose_quantity" value="{{ immunization.dose_quantity }}">
                                            </div>
                                        </div>

                                        <!-- Manufacturer -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="manufacturer_{{ immunization.id }}" class="form-label">Manufacturer</label>
                                                <input type="text" class="form-control" id="manufacturer_{{ immunization.id }}" name="manufacturer" value="{{ immunization.manufacturer }}">
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="notes_{{ immunization.id }}" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes_{{ immunization.id }}" name="notes">{{ immunization.notes }}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}  

                <!-- Edit Medication Modals -->
                {% for medication in medications %}
                <div class="modal fade" id="editMedicationModal{{ medication.id }}" tabindex="-1" aria-labelledby="editMedicationModalLabel{{ medication.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_medication', patient_id=patient.id, medication_id=medication.id) }}">
                                {{ medicationform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editMedicationModalLabel{{ medication.id }}">Edit Medication</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <!-- Medication Code -->
                                            <div class="form-group mb-3">
                                                <label for="medication_code_{{ medication.id }}" class="form-label">Medication Code</label>
                                                <input type="text" class="form-control" id="medication_code_{{ medication.id }}" name="medication_code" value="{{ medication.medication_code }}" required>
                                            </div>

                                            <!-- Medication Name -->
                                            <div class="form-group mb-3">
                                                <label for="medication_name_{{ medication.id }}" class="form-label">Medication Name</label>
                                                <input type="text" class="form-control" id="medication_name_{{ medication.id }}" name="medication_name" value="{{ medication.medication_name }}" required>
                                            </div>

                                            <!-- Status -->
                                            <div class="form-group mb-3">
                                                <label for="status_{{ medication.id }}" class="form-label">Status</label>
                                                <select class="form-control" id="status_{{ medication.id }}" name="status" required>
                                                    {% for code, display in medicationform.status.choices %}
                                                    <option value="{{ code }}" {% if medication.status == code %}selected{% endif %}>{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Start Date -->
                                            <div class="form-group mb-3">
                                                <label for="effectivePeriod_start_{{ medication.id }}" class="form-label">Start Date</label>
                                                <input type="date" class="form-control" id="effectivePeriod_start_{{ medication.id }}" name="effectivePeriod_start" value="{{ medication.effectivePeriod_start }}" required>
                                            </div>

                                            <!-- End Date -->
                                            <div class="form-group mb-3">
                                                <label for="effectivePeriod_end_{{ medication.id }}" class="form-label">End Date</label>
                                                <input type="date" class="form-control" id="effectivePeriod_end_{{ medication.id }}" name="effectivePeriod_end" value="{{ medication.effectivePeriod_end }}">
                                            </div>

                                            <!-- Date Asserted -->
                                            <div class="form-group mb-3">
                                                <label for="date_asserted_{{ medication.id }}" class="form-label">Date Asserted</label>
                                                <input type="date" class="form-control" id="date_asserted_{{ medication.id }}" name="date_asserted" value="{{ medication.date_asserted }}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <!-- Adherence -->
                                            <div class="form-group mb-3">
                                                <label for="adherence_{{ medication.id }}" class="form-label">Adherence</label>
                                                <select class="form-control" id="adherence_{{ medication.id }}" name="adherence">
                                                    {% for code, display in medicationform.adherence.choices %}
                                                    <option value="{{ code }}" {% if medication.adherence == code %}selected{% endif %}>{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Reason Code -->
                                            <div class="form-group mb-3">
                                                <label for="reason_code_{{ medication.id }}" class="form-label">Reason Code</label>
                                                <textarea class="form-control" id="reason_code_{{ medication.id }}" name="reason_code">{{ medication.reason_code }}</textarea>
                                            </div>

                                            <!-- Reason Reference -->
                                            <div class="form-group mb-3">
                                                <label for="reason_reference_{{ medication.id }}" class="form-label">Reason Reference</label>
                                                <input type="text" class="form-control" id="reason_reference_{{ medication.id }}" name="reason_reference" value="{{ medication.reason_reference }}">
                                            </div>

                                            <!-- Status Reason -->
                                            <div class="form-group mb-3">
                                                <label for="status_reason_{{ medication.id }}" class="form-label">Status Reason</label>
                                                <input type="text" class="form-control" id="status_reason_{{ medication.id }}" name="status_reason" value="{{ medication.status_reason }}">
                                            </div>

                                            <!-- Dosage Instruction -->
                                            <div class="form-group mb-3">
                                                <label for="dosage_instruction_{{ medication.id }}" class="form-label">Dosage Instruction</label>
                                                <textarea class="form-control" id="dosage_instruction_{{ medication.id }}" name="dosage_instruction">{{ medication.dosage_instruction }}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <!-- Information Source -->
                                            <div class="form-group mb-3">
                                                <label for="information_source_{{ medication.id }}" class="form-label">Information Source</label>
                                                <input type="text" class="form-control" id="information_source_{{ medication.id }}" name="information_source" value="{{ medication.information_source }}">
                                            </div>

                                            <!-- Notes -->
                                            <div class="form-group mb-3">
                                                <label for="notes_{{ medication.id }}" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes_{{ medication.id }}" name="notes">{{ medication.notes }}</textarea>
                                            </div>

                                            <!-- Category -->
                                            <div class="form-group mb-3">
                                                <label for="category_{{ medication.id }}" class="form-label">Category</label>
                                                <select class="form-control" id="category_{{ medication.id }}" name="category">
                                                    {% for code, display in medicationform.category.choices %}
                                                    <option value="{{ code }}" {% if medication.category == code %}selected{% endif %}>{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Route of Administration -->
                                            <div class="form-group mb-3">
                                                <label for="route_of_administration_{{ medication.id }}" class="form-label">Route of Administration</label>
                                                <input type="text" class="form-control" id="route_of_administration_{{ medication.id }}" name="route_of_administration" value="{{ medication.route_of_administration }}">
                                            </div>

                                            <!-- Timing -->
                                            <div class="form-group mb-3">
                                                <label for="timing_{{ medication.id }}" class="form-label">Timing</label>
                                                <input type="text" class="form-control" id="timing_{{ medication.id }}" name="timing" value="{{ medication.timing }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Edit Allergy Modals -->
                {% for allergy in allergies %}
                <div class="modal fade" id="editAllergyModal{{ allergy.id }}" tabindex="-1" aria-labelledby="editAllergyModalLabel{{ allergy.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_allergy', patient_id=patient.id, allergy_id=allergy.id) }}">
                                {{ allergyform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editAllergyModalLabel{{ allergy.id }}">Edit Allergy</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <!-- Substance -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="substance_{{ allergy.id }}" class="form-label">Substance</label>
                                                <input type="text" class="form-control" id="substance_{{ allergy.id }}" name="substance" value="{{ allergy.substance }}" required>
                                            </div>
                                        </div>

                                        <!-- Clinical Status -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="clinical_status_{{ allergy.id }}" class="form-label">Clinical Status</label>
                                                <select class="form-control" id="clinical_status_{{ allergy.id }}" name="clinical_status" required>
                                                    {% for code, display in allergyform.clinical_status.choices %}
                                                    <option value="{{ code }}" {% if allergy.clinical_status == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Verification Status -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="verification_status_{{ allergy.id }}" class="form-label">Verification Status</label>
                                                <select class="form-control" id="verification_status_{{ allergy.id }}" name="verification_status" required>
                                                    {% for code, display in allergyform.verification_status.choices %}
                                                    <option value="{{ code }}" {% if allergy.verification_status == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Severity -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="severity_{{ allergy.id }}" class="form-label">Severity</label>
                                                <select class="form-control" id="severity_{{ allergy.id }}" name="severity" required>
                                                    {% for code, display in allergyform.severity.choices %}
                                                    <option value="{{ code }}" {% if allergy.severity == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Category -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="category_{{ allergy.id }}" class="form-label">Category</label>
                                                <select class="form-control" id="category_{{ allergy.id }}" name="category" required>
                                                    {% for code, display in allergyform.category.choices %}
                                                    <option value="{{ code }}" {% if allergy.category == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Reaction -->
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="reaction_{{ allergy.id }}" class="form-label">Reaction</label>
                                                <textarea class="form-control" id="reaction_{{ allergy.id }}" name="reaction">{{ allergy.reaction }}</textarea>
                                            </div>
                                        </div>

                                        <!-- Onset (Immediate or Delayed) -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="onset_{{ allergy.id }}" class="form-label">Onset</label>
                                                <select class="form-control" id="onset_{{ allergy.id }}" name="onset" required>
                                                    <option value="immediate" {% if allergy.onset == 'immediate' %}selected{% endif %}>Immediate</option>
                                                    <option value="delayed" {% if allergy.onset == 'delayed' %}selected{% endif %}>Delayed</option>
                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Edit Medical History Modals -->
                {% for medicalhistory in medicalhistory  %}
                <div class="modal fade" id="editMedicalHistoryModal{{ medicalhistory.id }}" tabindex="-1" aria-labelledby="editMedicalHistoryModalLabel{{ medicalhistory.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_medical_history', patient_id=patient.id, medicalhistory_id=medicalhistory.id) }}">
                                {{ editmedicalhistoryform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editMedicalHistoryModalLabel{{ medicalhistory.id }}">Edit Medical History</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <!-- Clinical Status -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="clinical_status_{{ medicalhistory.id }}" class="form-label">Clinical Status</label>
                                                <select class="form-control" id="clinical_status_{{ medicalhistory.id }}" name="clinical_status" required>
                                                    {% for option in medicalhistoryform.clinical_status.choices %}
                                                    <option value="{{ option[0] }}" {% if medicalhistory.clinical_status == option[0] %}selected{% endif %}>
                                                        {{ option[1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Verification Status -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="verification_status_{{ medicalhistory.id }}" class="form-label">Verification Status</label>
                                                <select class="form-control" id="verification_status_{{ medicalhistory.id }}" name="verification_status" required>
                                                    {% for option in medicalhistoryform.verification_status.choices %}
                                                    <option value="{{ option[0] }}" {% if medicalhistory.verification_status == option[0] %}selected{% endif %}>
                                                        {{ option[1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Category -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="category_{{ medicalhistory.id }}" class="form-label">Category</label>
                                                <select class="form-control" id="category_{{ medicalhistory.id }}" name="category" required>
                                                    {% for option in medicalhistoryform.category.choices %}
                                                    <option value="{{ option[0] }}" {% if medicalhistory.category == option[0] %}selected{% endif %}>
                                                        {{ option[1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Code -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="code_{{ medicalhistory.id }}" class="form-label">Code</label>
                                                <select class="form-control" id="code_{{ medicalhistory.id }}" name="code" required>
                                                    {% for option in medicalhistoryform.code.choices %}
                                                    <option value="{{ option[0] }}" {% if medicalhistory.code == option[0] %}selected{% endif %}>
                                                        {{ option[1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Onset Date -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="onset_date_{{ medicalhistory.id }}" class="form-label">Onset Date</label>
                                                <input type="date" class="form-control" id="onset_date_{{ medicalhistory.id }}" name="onset_date" value="{{ medicalhistory.onset_date }}" required>
                                            </div>
                                        </div>

                                        <!-- Abatement Date -->
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="abatement_date_{{ medicalhistory.id }}" class="form-label">Abatement Date</label>
                                                <input type="date" class="form-control" id="abatement_date_{{ medicalhistory.id }}" name="abatement_date" value="{{ medicalhistory.abatement_date }}" required>
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="notes_{{ medicalhistory.id }}" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes_{{ medicalhistory.id }}" name="notes" rows="3">{{ medicalhistory.notes }}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}         
            
                <!-- Edit Appointment Modals -->
                {% for appointment in patient.appointments %}
                <div class="modal fade" id="editAppointmentModal{{ appointment.id }}" tabindex="-1" aria-labelledby="editAppointmentModalLabel{{ appointment.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_appointment', patient_id=appointment.patient_id, appointment_id=appointment.id) }}">
                                {{ appointmentform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editAppointmentModalLabel{{ appointment.id }}">Edit Appointment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <!-- Start Time -->
                                            <div class="form-group mb-3">
                                                <div class="form-group mb-3">
                                                    <label for="start_{{ appointment.id }}" class="form-label">Start Time</label>
                                                    <input type="datetime-local" class="form-control" id="start_{{ appointment.id }}" name="start" value="{{ appointment.start.strftime('%Y-%m-%dT%H:%M') if appointment.start else '' }}" required>
                                                </div>
                                            </div>
            
                                            <!-- End Time -->
                                            <div class="form-group mb-3">
                                                <div class="form-group mb-3">
                                                    <label for="end_{{ appointment.id }}" class="form-label">End Time</label>
                                                    <input type="datetime-local" class="form-control" id="end_{{ appointment.id }}" name="end" value="{{ appointment.end.strftime('%Y-%m-%dT%H:%M') if appointment.end else '' }}">
                                                </div>
                                            </div>
                                        
                                            <div class="form-group mb-3">
                                                <label for="service_category_{{ appointment.id }}" class="form-label">Service Category</label>
                                                <select class="form-control" id="service_category_{{ appointment.id }}" name="service_category">
                                                    {% for code, display in appointmentform.service_category.choices %}
                                                    <option value="{{ code }}" {% if appointment.service_category == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                    
            
                                            <div class="form-group mb-3">
                                                <label for="service_type_{{ appointment.id }}" class="form-label">Service Type</label>
                                                <select class="form-control" id="service_type_{{ appointment.id }}" name="service_type">
                                                    {% for code, display in appointmentform.service_type.choices %}
                                                    <option value="{{ code }}" {% if appointment.service_type == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                    
            
                                
                                            <div class="form-group mb-3">
                                                <label for="specialty_{{ appointment.id }}" class="form-label">Specialty</label>
                                                <select class="form-control" id="specialty_{{ appointment.id }}" name="specialty">
                                                    {% for code, display in appointmentform.specialty.choices %}
                                                    <option value="{{ code }}" {% if appointment.specialty == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                    
            
                                            <div class="form-group mb-3">
                                                <label for="appointment_type_{{ appointment.id }}" class="form-label">Appointment Type</label>
                                                <select class="form-control" id="appointment_type_{{ appointment.id }}" name="appointment_type">
                                                    {% for code, display in appointmentform.appointment_type.choices %}
                                                    <option value="{{ code }}" {% if appointment.appointment_type == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="participant_actor_{{ appointment.id }}" class="form-label">Participant Actor</label>
                                                <select class="form-control" id="participant_actor_{{ appointment.id }}" name="participant_actor">
                                                    {% for code, display in appointmentform.participant_actor.choices %}
                                                    <option value="{{ code }}" {% if appointment.participant_actor == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="priority_{{ appointment.id }}" class="form-label">Priority</label>
                                                <select class="form-control" id="priority_{{ appointment.id }}" name="priority">
                                                    {% for code, display in appointmentform.priority.choices %}
                                                    <option value="{{ code }}" {% if appointment.priority == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="participant_status_{{ appointment.id }}" class="form-label">Participant Status</label>
                                                <select class="form-control" id="participant_status_{{ appointment.id }}" name="participant_status">
                                                    {% for code, display in appointmentform.participant_status.choices %}
                                                    <option value="{{ code }}" {% if appointment.participant_status == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="reason_code_{{ appointment.id }}" class="form-label">Reason Code</label>
                                                <select class="form-control" id="reason_code_{{ appointment.id }}" name="reason_code">
                                                    {% for code, display in appointmentform.reason_code.choices %}
                                                    <option value="{{ code }}" {% if appointment.reason_code == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="status_{{ appointment.id }}" class="form-label">Status</label>
                                                <select class="form-control" id="status_{{ appointment.id }}" name="status" required>
                                                    {% for code, display in appointmentform.status.choices %}
                                                    <option value="{{ code }}" {% if appointment.status == code %}selected{% endif %}>
                                                        {{ display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}    

                <!-- Add Medical History Modal -->
                <div class="modal fade" id="addMedicalHistoryModal" tabindex="-1" aria-labelledby="addMedicalHistoryModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.add_medical_history', patient_id=patient.id) }}">
                                {{ medicalhistoryform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addMedicalHistoryModalLabel">Add Medication History</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                            <!-- Clinical Status -->
                                            <div class="form-group mb-3">
                                                <label for="clinical_status" class="form-label">Clinical Status</label>
                                                <select class="form-control" id="clinical_status" name="clinical_status" required>
                                                    {% for code, display in medicalhistoryform.clinical_status.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Verification Status -->
                                            <div class="form-group mb-3">
                                                <label for="verification_status" class="form-label">Status</label>
                                                <select class="form-control" id="verification_status" name="verification_status" required>
                                                    {% for code, display in medicalhistoryform.verification_status.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Category -->
                                            <div class="form-group mb-3">
                                                <label for="category" class="form-label">Category</label>
                                                <select class="form-control" id="category" name="category" required>
                                                    {% for code, display in medicalhistoryform.category.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Code -->
                                            <div class="form-group mb-3">
                                                <label for="code" class="form-label">Code</label>
                                                <select class="form-control" id="code" name="code" required>
                                                    {% for code, display in medicalhistoryform.code.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Onset date -->
                                            <div class="form-group mb-3">
                                                <label for="onset_date" class="form-label">Onset Date</label>
                                                <input type="date" class="form-control" id="onset_date" name="onset_date" required>
                                            </div>
                                            
                                            <!-- abatement date -->
                                            <div class="form-group mb-3">
                                                <label for="abatement_date" class="form-label">Abatement Date</label>
                                                <input type="date" class="form-control" id="abatement_date" name="abatement_date" required>
                                            </div>

                                            <!-- Note -->
                                            <div class="form-group mb-3">
                                                <label for="notes" class="form-label">Note</label>
                                                <textarea class="form-control" id="notes" name="notes"></textarea>
                                            </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Add Allergy</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Upload Laboratory Scan Modal -->
                <div class="modal fade" id="uploadLabScanModal" tabindex="-1" aria-labelledby="uploadLabScanModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.upload_document', patient_id=patient.id) }}" enctype="multipart/form-data">
                                {{ uploadform.hidden_tag() }}
                                <div class="mb-3">
                                    <label for="documentName" class="form-label">Document Name</label>
                                    {{ uploadform.document_name(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    <label for="documentFile" class="form-label">Select File</label>
                                    {{ uploadform.document_file(class="form-control") }}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Upload Additional Document Modal -->
                <div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.upload_document', patient_id=patient.id) }}" enctype="multipart/form-data">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="uploadDocumentModalLabel">Upload Document</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="documentName" class="form-label">Document Name</label>
                                        <input type="text" class="form-control" id="documentName" name="document_name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="documentFile" class="form-label">Select File</label>
                                        <input type="file" class="form-control" id="documentFile" name="document_file" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Appointment List -->
    <div>
        <div>
            <h3 class="d-flex justify-content-between align-items-center mb-3">
                Appointment
                <!-- Add Appointment Button -->
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#appointmentModal">Add Appointment</button>
                <!-- Add Appointment Modal -->
                <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.add_appointment', patient_id=patient.id) }}">
                                {{ appointmentform.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="appointmentModalLabel">Add Appointment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <!-- Start Time -->
                                            <div class="form-group mb-3">
                                                <label for="start" class="form-label">Start Time</label>
                                                <input type="datetime-local" class="form-control" id="start" name="start" required>
                                            </div>
    
                                            <!-- End Time -->
                                            <div class="form-group mb-3">
                                                <label for="end" class="form-label">End Time</label>
                                                <input type="datetime-local" class="form-control" id="end" name="end">
                                            </div>
                                            <!-- Service Category -->
                                            <div class="form-group mb-3">
                                                <label for="service_category" class="form-label">Service Category</label>
                                                <select class="form-control" id="service_category" name="service_category">
                                                    {% for code, display in appointmentform.service_category.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
    
                                            <!-- Service Type -->
                                            <div class="form-group mb-3">
                                                <label for="service_type" class="form-label">Service Type</label>
                                                <select class="form-control" id="service_type" name="service_type">
                                                    {% for code, display in appointmentform.service_type.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
    
                                            <!-- Specialty -->
                                            <div class="form-group mb-3">
                                                <label for="specialty" class="form-label">Specialty</label>
                                                <select class="form-control" id="specialty" name="specialty">
                                                    {% for code, display in appointmentform.specialty.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <!-- Appointment Type -->
                                            <div class="form-group mb-3">
                                                <label for="appointment_type" class="form-label">Appointment Type</label>
                                                <select class="form-control" id="appointment_type" name="appointment_type">
                                                    {% for code, display in appointmentform.appointment_type.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <!-- Priority -->
                                            <div class="form-group mb-3">
                                                <label for="priority" class="form-label">Priority</label>
                                                <select class="form-control" id="priority" name="priority">
                                                    {% for code, display in appointmentform.priority.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
    
                                            <!-- Participant Actor -->
                                            <div class="form-group mb-3">
                                                <label for="participant_actor" class="form-label">Participant Actor</label>
                                                <select class="form-control" id="participant_actor" name="participant_actor">
                                                    {% for code, display in appointmentform.participant_actor.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
    
                                            <!-- Participant Status -->
                                            <div class="form-group mb-3">
                                                <label for="participant_status" class="form-label">Participant Status</label>
                                                <select class="form-control" id="participant_status" name="participant_status">
                                                    {% for code, display in appointmentform.participant_status.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <!-- Reason Code -->
                                            <div class="form-group mb-3">
                                                <label for="reason_code" class="form-label">Reason Code</label>
                                                <select class="form-control" id="reason_code" name="reason_code">
                                                    {% for code, display in appointmentform.reason_code.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <!-- Status -->
                                            <div class="form-group mb-3">
                                                <label for="status" class="form-label">Status</label>
                                                <select class="form-control" id="status" name="status" required>
                                                    {% for code, display in appointmentform.status.choices %}
                                                    <option value="{{ code }}">{{ display }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Add Appointment</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </h3>
            <small>Latest upcoming appointmnets.</small>
        </div>
        <div>
            <div>
                {% if latest_appointments and latest_appointments|length > 0 %}
                    {% for appointment in latest_appointments %}
                        {% if appointment.status != "fulfilled" %}
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Next appointment {{ appointment.start.strftime('%Y-%m-%d') }}</span>
                                </div>
                                <table class="table table-bordered table-striped outline-table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Service Category</th>
                                            <th>Service Type</th>
                                            <th>Specialty</th>
                                            <th>Appointment Type</th>
                                            <th>Priority</th>
                                            <th>Reason</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>{{ appointment.service_category }}</td>
                                            <td>{{ appointment.service_type }}</td>
                                            <td>{{ appointment.specialty }}</td>
                                            <td>{{ appointment.appointment_type }}</td>
                                            <td>{{ appointment.priority }}</td>
                                            <td>{{ appointment.reason_code }}</td>
                                            <td>{{ appointment.start }}</td>
                                            <td>{{ appointment.end }}</td>
                                            <td>{{ appointment.status }}</td>
                                            <td>
                                                <!-- Edit Button -->
                                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editAppointmentModal{{ appointment.id }}">Edit</button>
                                                <!-- Delete Button -->
                                                <form method="POST" action="{{ url_for('main.delete_appointment', appointment_id=appointment.id) }}" style="display:inline;">
                                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this appointment?');">Delete</button>
                                                </form>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p>No upcoming appointments available.</p>
            {% endif %}
            </div>
        </div>
    </div>
    <br>
<!-- Visit List -->
    <div>
        <h3>Visits</h3>
        <table class="table table-bordered table-hover table-striped outline-table">
            <thead>
                <tr class="table-dark-row">
                    <th>ID</th>
                    <th>Visit Date</th>
                    <th>Reason Code</th>
                    <th>Class</th>
                    <th>Priority</th>
                    <th>Notes</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for visit in sorted_visits %}
                <tr>
                    <td>{{ visit.id }}</td>
                    <td>{{ visit.visit_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ visit.reason_code }} - {{ visit.reason_code_description }}</td>
                    <td>{{ visit.class_code }}</td>  <!-- Assuming 'class_code' is an attribute of Visit -->
                    <td>{{ visit.priority }}</td>  <!-- Assuming 'priority' is an attribute of Visit -->
                    <td>{{ visit.notes }}</td>
                    <td>{{ visit.status }}</td>
                    <td>
                        <div class="row">
                            <div class="col-md-6">
                                <a href="{{ url_for('main.view_visit', visit_id=visit.id) }}" class="btn btn-info btn-sm w-100">View Details</a>
                            </div>
                            <div class="col-md-6">
                                <button class=" btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#deleteVisitModal{{ visit.id }}">
                                    Delete
                                </button>
                                <!-- Confirmation Modal -->
                                <div class="modal fade" id="deleteVisitModal{{ visit.id }}" tabindex="-1" aria-labelledby="deleteVisitModalLabel{{ visit.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form method="POST" action="{{ url_for('main.delete_visit', visit_id=visit.id) }}">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="deleteVisitModalLabel{{ visit.id }}">Confirm Visit Deletion</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>To confirm deletion, please enter the full name of the patient:</p>
                                                    <input type="text" name="patient_name" class="form-control" placeholder="Patient Name" required>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-danger">Delete Visit</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8">No visits recorded.</td>
                </tr>
                {% endfor %}

                
            </tbody>        
        </table>

        <!-- Button to trigger modal for adding new visit -->
        <button class="btn btn-success mt-4" data-bs-toggle="modal" data-bs-target="#addVisitModal">Add New Visit</button>
        <!-- Modal for Adding New Patient -->
        <div class="modal fade" id="addVisitModal" tabindex="-1" aria-labelledby="addVisitModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form method="POST"  action="{{ url_for('main.add_visit', patient_id=patient.id) }}">
                        {{ visit_form.hidden_tag() }}
                        <div class="modal-header">
                            <h5 class="modal-title" id="addVisitModalLabel">Add New Patient</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                {{ visit_form.reason_code.label(class="form-label") }}
                                {{ visit_form.reason_code(class="form-select") }}
                                {% for error in visit_form.reason_code.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Diagnosis Code -->
                              <div class="mb-3">
                                {{ visit_form.diagnosis_code.label(class="form-label") }}
                                {{ visit_form.diagnosis_code(class="form-control") }}
                                {% for error in visit_form.diagnosis_code.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Status -->
                              <div class="mb-3">
                                {{ visit_form.status.label(class="form-label") }}
                                {{ visit_form.status(class="form-select") }}
                                {% for error in visit_form.status.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Class Code -->
                              <div class="mb-3">
                                {{ visit_form.class_code.label(class="form-label") }}
                                {{ visit_form.class_code(class="form-select") }}
                                {% for error in visit_form.class_code.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Priority -->
                              <div class="mb-3">
                                {{ visit_form.priority.label(class="form-label") }}
                                {{ visit_form.priority(class="form-select") }}
                                {% for error in visit_form.priority.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Location -->
                              <div class="mb-3">
                                {{ visit_form.location.label(class="form-label") }}
                                {{ visit_form.location(class="form-select") }}
                                {% for error in visit_form.location.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Visit Date -->
                              <div class="mb-3">
                                {{ visit_form.visit_date.label(class="form-label") }}
                                {{ visit_form.visit_date(class="form-control") }}
                                {% for error in visit_form.visit_date.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>
                    
                              <!-- Notes -->
                              <div class="mb-3">
                                {{ visit_form.notes.label(class="form-label") }}
                                {{ visit_form.notes(class="form-control") }}
                                {% for error in visit_form.notes.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                              </div>                    
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Add Patient</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const hash = window.location.hash; // Get the hash from the URL
        if (hash) {
            // Find the tab link corresponding to the hash
            const targetTab = document.querySelector(`a[href="${hash}"]`);
            if (targetTab) {
                const tab = new bootstrap.Tab(targetTab); // Use Bootstrap's Tab API
                tab.show(); // Activate the tab
            }
        }
    });
</script>
