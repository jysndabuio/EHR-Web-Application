<!-- templates/view_patient.html -->

{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2>Patient Details</h2>
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ patient.firstname }} {{ patient.lastname }}</h5>
            <a href="{{ url_for('main.edit_patient', patient_id=patient.id) }}" class="btn btn-primary btn-sm">Edit</a>
        </div>        
        <div class="card-body">
            <p><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
            <p><strong>Age:</strong> {{ patient.age }}</p>
            <p><strong>Gender:</strong> {{ patient.gender }}</p>
            <p><strong>Contact Number:</strong> {{ patient.contact_number }}</p>
            <p><strong>Home Address:</strong> {{ patient.home_address }}</p>
            <p><strong>Emergency Contact:</strong> {{ patient.ecd_name }} ({{ patient.ecd_contact_number }})</p>
        </div>
    </div>

    <h3>Appointment</h3>

    {% if latest_appointment %}
    <div class="card mb-3">
        <div class="card-header">
            Next appointment {{ latest_appointment.start.strftime('%Y-%m-%d') }}
            <a href="{{ url_for('main.view_visit', visit_id=latest_appointment.visit_id) }}" class="btn btn-info btn-sm float-right">View Details</a>
        </div>
        <div class="card-body">
            <p><strong>Visit Type:</strong> {{ latest_appointment.visit_type }}</p>
            <p><strong>Notes:</strong> {{ latest_appointment.notes }}</p>
        </div>
    </div>
    {% else %}
    <p>No upcoming appointments available.</p>
    {% endif %}

    <h3>Visits</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Visit Date</th>
                <th>Reason Code</th>
                <th>Class</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for visit in sorted_visits %}
            <tr>
                <td>{{ visit.id }}</td>
                <td>{{ visit.visit_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ visit.reason_code }} - {{ visit.reason_code_description }}</td>
                <td>{{ visit.class_code }}</td>  <!-- Assuming 'class_code' is an attribute of Visit -->
                <td>{{ visit.priority }}</td>  <!-- Assuming 'priority' is an attribute of Visit -->
                <td>{{ visit.status }}</td>
                <td>
                    <a href="{{ url_for('main.view_visit', visit_id=visit.id) }}" class="btn btn-info btn-sm">View Details</a>
                </td>
                <td>
                    <!-- Delete Button -->
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteVisitModal{{ visit.id }}">
                        Delete
                    </button>
        
                    <!-- Confirmation Modal -->
                    <div class="modal fade" id="deleteVisitModal{{ visit.id }}" tabindex="-1" aria-labelledby="deleteVisitModalLabel{{ visit.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{{ url_for('main.delete_visit', visit_id=visit.id) }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="deleteVisitModalLabel{{ visit.id }}">Confirm Visit Deletion</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>To confirm deletion, please enter the full name of the patient:</p>
                                        <input type="text" name="patient_name" class="form-control" placeholder="Patient Name" required>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-danger">Delete Visit</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8">No visits recorded.</td>
            </tr>
            {% endfor %}
        </tbody>        
    </table>

    <!-- Add Visit Button -->
    <a href="{{ url_for('main.add_visit', patient_id=patient.id) }}" class="btn btn-primary mt-3">Add New Visit</a>
</div>
{% endblock %}
